<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Family Music Quiz</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 820px; margin: 24px auto; padding: 0 12px; }
    button { padding: 10px 12px; margin: 6px 6px 6px 0; }
    select, input { padding: 8px; margin: 6px 6px 6px 0; }
    .box { border: 1px solid #ddd; padding: 12px; border-radius: 10px; margin-top: 12px; }
    .ok { color: #0a7a0a; }
    .bad { color: #b00020; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body>


<h1>Family Music Quiz</h1>

<div class="box">
  <h2>1) Verbindung</h2>
  <button id="loginBtn">Mit Spotify verbinden</button>
  <button id="logoutBtn">Logout (Token l√∂schen)</button>
  <div id="connStatus"></div>
</div>

<div class="box">
  <h2>2) Playlists laden</h2>
  <button id="loadPlaylistsBtn">Meine Playlists laden</button>
  <div id="playlistStatus"></div>
  <div id="playlistsUI" style="display:none;">
    <p><b>Gefundene Playlists:</b></p>
    <select id="playlistSelect" style="min-width: 320px;"></select>
    <button id="showTracksBtn">Tracks in dieser Playlist anzeigen</button>
  </div>
</div>

<div class="box">
  <h2>3) Runde</h2>
  <button onclick="drawRandomSong()">üé≤ Zuf√§lligen Song ziehen</button>
  <button onclick="revealSong()">üëÄ Reveal</button>
  <p id="drawStatus"></p>
  <div id="revealBox" style="display:none; margin-top:10px;"></div>
</div>

  <div class="box">
  <h2>4) Debug</h2>
  <pre id="debug"></pre>
</div>


<script>
const clientId = "1567cc8cfec14ea2b8562efca5dd7e08";
const redirectUri = "https://skarvaan.github.io/family-music-quiz/callback.html";

const scope = [
  "playlist-read-private",
  "playlist-read-collaborative",
  "user-read-playback-state",
  "user-modify-playback-state"
].join(" ");

const connStatus = document.getElementById("connStatus");
const debugEl = document.getElementById("debug");
const playlistStatus = document.getElementById("playlistStatus");
const playlistsUI = document.getElementById("playlistsUI");
const playlistSelect = document.getElementById("playlistSelect");

let currentTracks = [];
let currentSong = null;

function setDebug(msg) { debugEl.textContent = msg; }
function setConn(html) { connStatus.innerHTML = html; }
function setPlaylistStatus(html) { playlistStatus.innerHTML = html; }

function getToken() {
  return localStorage.getItem("spotify_access_token");
}

async function apiGet(url) {
  const token = getToken();
  if (!token) throw new Error("Kein Token vorhanden (bitte neu verbinden).");

  let res;
  try {
    res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
  } catch (e) {
    throw new Error("Netzwerkfehler beim Fetch (evtl. Tracking-Blocker/WLAN/DNS): " + e.message);
  }

  const text = await res.text(); // wichtig: erst text, dann JSON parse
  let data = null;
  try { data = text ? JSON.parse(text) : null; } catch { /* ignore */ }

  if (!res.ok) {
    const msg = data?.error?.message || data?.error_description || text || `HTTP ${res.status}`;
    throw new Error(`Spotify API Fehler (${res.status}): ${msg}`);
  }

  return data;
}


async function loadPlaylists() {
  setPlaylistStatus("Lade‚Ä¶");
  setDebug("");

  try {
    const data = await apiGet("https://api.spotify.com/v1/me/playlists?limit=50");

    const items = data.items || [];
    playlistSelect.innerHTML = "";

    if (!items.length) {
      setPlaylistStatus("‚ö†Ô∏è Keine Playlists gefunden (oder keine gespeichert).");
      setDebug(JSON.stringify(data, null, 2));
      return;
    }

    items.forEach(pl => {
  const opt = document.createElement("option");
  opt.value = pl.id;

  const total = (pl.tracks && typeof pl.tracks.total === "number") ? pl.tracks.total : "?";
  const name = pl.name || "(ohne Namen)";

  opt.textContent = `${name} (${total} Tracks)`;
  playlistSelect.appendChild(opt);
});


    playlistsUI.style.display = "block";
    setPlaylistStatus(`‚úÖ ${items.length} Playlists geladen`);
    setDebug(JSON.stringify(items.map(p => ({
  name: p.name,
  id: p.id,
  total: p.tracks?.total ?? null
})), null, 2));

  } catch (e) {
    setPlaylistStatus("‚ùå " + e.message);
    setDebug("Fehler-Details:\n" + (e.stack || e.message));
  }
}


async function loadTracksFromPlaylist() {
  const id = playlistSelect.value;
  if (!id) {
    setPlaylistStatus("‚ùå Keine Playlist ausgew√§hlt.");
    return;
  }

  setPlaylistStatus("Lade Tracks‚Ä¶");
  setDebug("");

  try {
    const data = await apiGet(`https://api.spotify.com/v1/playlists/${id}/tracks?limit=100`);

    const items = data.items || [];

    // robust filtern: manche Eintr√§ge haben track=null
    currentTracks = items
      .map(x => x && x.track ? x.track : null)
      .filter(t => t && t.name && t.album && t.artists && t.artists.length);

    if (!currentTracks.length) {
      setPlaylistStatus("‚ö†Ô∏è Keine Tracks gefunden (oder alle sind nicht verf√ºgbar).");
      setDebug(JSON.stringify(data, null, 2));
      return;
    }

    setPlaylistStatus(`‚úÖ ${currentTracks.length} Tracks geladen`);
    setDebug(JSON.stringify(currentTracks.slice(0, 10).map(t => ({
      name: t.name,
      artists: t.artists.map(a => a.name).join(", "),
      release_date: t.album?.release_date
    })), null, 2));

  } catch (e) {
    setPlaylistStatus("‚ùå " + e.message);
    setDebug("Fehler-Details:\n" + (e.stack || e.message));
  }
}


function drawRandomSong() {
  if (!currentTracks.length) {
    alert("Erst Tracks laden!");
    return;
  }

  const index = Math.floor(Math.random() * currentTracks.length);
  currentSong = currentTracks[index];

  document.getElementById("revealBox").style.display = "none";
  document.getElementById("drawStatus").textContent =
    "üéµ Song gew√§hlt ‚Äì jetzt raten!";
}

function revealSong() {
  if (!currentSong) return;

  const year = currentSong.album.release_date?.slice(0,4) || "?";

  document.getElementById("revealBox").innerHTML = `
    <b>${currentSong.name}</b><br>
    ${currentSong.artists.map(a=>a.name).join(", ")}<br>
    Jahr: ${year}
  `;
  document.getElementById("revealBox").style.display = "block";
}

function login() {
  const verifier = [...crypto.getRandomValues(new Uint8Array(64))]
    .map(x => "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"[x % 62])
    .join("");
  localStorage.setItem("pkce_verifier", verifier);

  crypto.subtle.digest("SHA-256", new TextEncoder().encode(verifier)).then(buf => {
    const challenge = btoa(String.fromCharCode(...new Uint8Array(buf)))
      .replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");

    const url = "https://accounts.spotify.com/authorize?" + new URLSearchParams({
      response_type: "code",
      client_id: clientId,
      scope,
      redirect_uri: redirectUri,
      code_challenge_method: "S256",
      code_challenge: challenge
    });

    window.location = url;
  });
}

  function logout() {
  localStorage.removeItem("spotify_access_token");
  localStorage.removeItem("spotify_auth_code");
  localStorage.removeItem("pkce_verifier");

  // UI zur√ºcksetzen
  currentTracks = [];
  currentSong = null;
  playlistsUI.style.display = "none";
  playlistSelect.innerHTML = "";
  document.getElementById("drawStatus").textContent = "";
  document.getElementById("revealBox").style.display = "none";
  document.getElementById("revealBox").innerHTML = "";

  setPlaylistStatus("üîí Token gel√∂scht.");
  refreshConnStatus();
}


function refreshConnStatus(){
  if(getToken()){
    setConn("‚úÖ Verbunden (Token vorhanden)");
  }else{
    setConn("‚ùå Nicht verbunden");
  }
}


document.getElementById("loginBtn").onclick = login;
document.getElementById("loadPlaylistsBtn").onclick = loadPlaylists;
document.getElementById("showTracksBtn").onclick = loadTracksFromPlaylist;
document.getElementById("logoutBtn").onclick = logout;


refreshConnStatus();
</script>

</body>
</html>
