<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Family Music Quiz</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 980px; margin: 24px auto; padding: 0 12px; }
    button { padding: 10px 12px; margin: 6px 6px 6px 0; cursor:pointer; }
    select, input { padding: 8px; margin: 6px 6px 6px 0; }
    .box { border: 1px solid #ddd; padding: 12px; border-radius: 10px; margin-top: 12px; }
    .ok { color: #0a7a0a; }
    .bad { color: #b00020; }
    .muted { color:#666; font-size: 12px; }
    pre { white-space: pre-wrap; word-break: break-word; background:#fafafa; border:1px solid #eee; padding:10px; border-radius:8px; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
    .playerRow { display:flex; gap:10px; flex-wrap: wrap; align-items:center; margin: 8px 0; padding: 8px; border: 1px dashed #ddd; border-radius: 10px; }
    .playerRow input { width: 180px; }
    .playerRow select { min-width: 320px; }
    .hidden { display:none !important; }
    .big { font-size: 22px; font-weight: 700; margin: 8px 0; }
  </style>
</head>
<body>

<h1>Family Music Quiz</h1>

<div class="box">
  <h2>1) Verbindung</h2>
  <button id="loginBtn">Mit Spotify verbinden</button>
  <button id="logoutBtn">Logout (Token l√∂schen)</button>
  <div id="connStatus"></div>
</div>

<!-- SETUP SCREEN -->
<div id="setupScreen" class="box">
  <h2>2) Setup</h2>

  <div class="row">
    <button id="loadPlaylistsBtn">Meine Playlists laden</button>
    <button id="testMeBtn">/me testen</button>
  </div>

  <div id="setupStatus"></div>

  <div class="row" style="margin-top:10px;">
    <label><b>Anzahl Spieler:</b></label>
    <input id="numPlayers" type="number" min="1" max="12" value="3" />
    <button id="buildPlayersBtn">Spielerfelder erstellen</button>
  </div>

  <div id="playersForm"></div>

  <div class="row" style="margin-top:12px;">
    <button id="startGameBtn">Spiel starten</button>
    <span class="muted">Start l√§dt automatisch alle gew√§hlten Playlists vollst√§ndig.</span>
  </div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen" class="box hidden">
  <h2>3) Runde</h2>

  <div id="turnPrompt" class="big"></div>

  <div id="turnButtons" class="row">
    <button id="readyBtn">‚úÖ Bereit</button>
    <button id="revealBtn" class="hidden">üëÄ Reveal</button>
    <button id="nextBtn" class="hidden">‚û°Ô∏è Weiter</button>
    <button id="stopBtn">‚è∏Ô∏è Stop</button>
  </div>

  <div id="gameStatus" class="muted"></div>
  <div id="revealBox" class="box hidden" style="margin-top:10px;"></div>
</div>

<div class="box">
  <h2>Debug</h2>
  <pre id="debug"></pre>
</div>

<script>
/*** ‚úÖ KONFIG ***/
const clientId = "1567cc8cfec14ea2b8562efca5dd7e08";
const redirectUri = "https://skarvaan.github.io/family-music-quiz/callback.html";

const scope = [
  "playlist-read-private",
  "playlist-read-collaborative",
  "user-read-playback-state",
  "user-modify-playback-state"
].join(" ");

/*** UI refs ***/
const connStatus = document.getElementById("connStatus");
const debugEl = document.getElementById("debug");

const setupScreen = document.getElementById("setupScreen");
const setupStatus = document.getElementById("setupStatus");
const playersForm = document.getElementById("playersForm");

const gameScreen = document.getElementById("gameScreen");
const turnPrompt = document.getElementById("turnPrompt");
const gameStatus = document.getElementById("gameStatus");
const revealBox = document.getElementById("revealBox");

const readyBtn = document.getElementById("readyBtn");
const revealBtn = document.getElementById("revealBtn");
const nextBtn = document.getElementById("nextBtn");
const stopBtn = document.getElementById("stopBtn");

/*** State ***/
// Playlists from Spotify:
let playlistList = []; // [{id,name,total}]

// Players:
let players = []; // [{name, playlistId, tracks:[], bag:[]}]
let currentPlayerIndex = 0;
let currentSong = null;

/*** helpers ***/
function setDebug(msg) { debugEl.textContent = msg || ""; }
function setConn(html) { connStatus.innerHTML = html; }
function setSetupStatus(html) { setupStatus.innerHTML = html; }
function setGameStatus(msg) { gameStatus.textContent = msg || ""; }

function getToken() { return localStorage.getItem("spotify_access_token"); }
function getScope() { return localStorage.getItem("spotify_scope") || ""; }

window.onerror = function(message, source, lineno, colno) {
  setDebug("JS ERROR:\n" + message + "\n" + source + ":" + lineno + ":" + colno);
};

function refreshConnStatus() {
  const s = getScope();
  setConn(getToken()
    ? `<span class="ok">‚úÖ Verbunden (Token vorhanden)</span><br><small>Scopes: ${s || "(unbekannt)"}</small>`
    : `<span class="bad">‚ùå Nicht verbunden</span>`
  );
}

function logout() {
  localStorage.removeItem("spotify_access_token");
  localStorage.removeItem("spotify_scope");
  localStorage.removeItem("pkce_verifier");
  localStorage.removeItem("spotify_auth_code");

  players = [];
  playlistList = [];
  currentPlayerIndex = 0;
  currentSong = null;

  playersForm.innerHTML = "";
  setSetupStatus("üîí Token gel√∂scht.");
  setGameStatus("");
  revealBox.classList.add("hidden");
  revealBox.innerHTML = "";
  setDebug("");
  showSetup();
  refreshConnStatus();
}

function showSetup(){
  setupScreen.classList.remove("hidden");
  gameScreen.classList.add("hidden");
}

function showGame(){
  setupScreen.classList.add("hidden");
  gameScreen.classList.remove("hidden");
}

/*** fetch helper ***/
async function apiGet(url, timeoutMs = 15000) {
  const token = getToken();
  if (!token) throw new Error("Kein Token vorhanden (bitte neu verbinden).");

  const ctrl = new AbortController();
  const timer = setTimeout(() => ctrl.abort(), timeoutMs);

  try {
    const res = await fetch(url, {
      headers: { Authorization: `Bearer ${token}` },
      signal: ctrl.signal
    });

    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch {}

    if (!res.ok) {
      const msg = data?.error?.message || data?.error_description || text || `HTTP ${res.status}`;
      throw new Error(`Spotify API Fehler (${res.status}): ${msg}`);
    }
    return data;
  } catch (e) {
    if (e.name === "AbortError") throw new Error("Timeout: Spotify antwortet nicht (15s).");
    throw e;
  } finally {
    clearTimeout(timer);
  }
}

/*** PKCE login ***/
function randomVerifier() {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  const bytes = crypto.getRandomValues(new Uint8Array(64));
  return Array.from(bytes, b => chars[b % chars.length]).join("");
}

async function sha256Base64Url(verifier) {
  const digest = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(verifier));
  return btoa(String.fromCharCode(...new Uint8Array(digest)))
    .replace(/=/g, "").replace(/\+/g, "-").replace(/\//g, "_");
}

async function login() {
  const verifier = randomVerifier();
  localStorage.setItem("pkce_verifier", verifier);
  const challenge = await sha256Base64Url(verifier);

  const url = "https://accounts.spotify.com/authorize?" + new URLSearchParams({
    response_type: "code",
    client_id: clientId,
    scope,
    redirect_uri: redirectUri,
    code_challenge_method: "S256",
    code_challenge: challenge,
    show_dialog: "true"
  });

  setDebug("Authorize URL:\n" + url);
  window.location = url;
}

/*** Spotify calls ***/
async function testMe() {
  setSetupStatus("Teste /me ‚Ä¶");
  try {
    const me = await apiGet("https://api.spotify.com/v1/me");
    setSetupStatus(`<span class="ok">‚úÖ /me ok: ${me.display_name}</span>`);
    setDebug(JSON.stringify(me, null, 2));
  } catch (e) {
    setSetupStatus(`<span class="bad">‚ùå ${e.message}</span>`);
    setDebug(e.stack || e.message);
  }
}

async function loadPlaylists() {
  setSetupStatus("Lade Playlists‚Ä¶");
  setDebug("");

  try {
    const data = await apiGet("https://api.spotify.com/v1/me/playlists?limit=50");
    const items = data.items || [];

    playlistList = items.map(pl => ({
      id: (pl.id || "").trim(),
      name: pl.name || "(ohne Namen)",
      total: (typeof pl.items?.total === "number") ? pl.items.total :
             (typeof pl.tracks?.total === "number") ? pl.tracks.total :
             null
    })).filter(p => p.id);

    setSetupStatus(`<span class="ok">‚úÖ ${playlistList.length} Playlists geladen</span>`);
    setDebug(JSON.stringify(playlistList.slice(0, 20), null, 2));
  } catch (e) {
    setSetupStatus(`<span class="bad">‚ùå ${e.message}</span>`);
    setDebug(e.stack || e.message);
  }
}

/*** Load ALL playlist items (pagination) ***/
async function loadAllTracksForPlaylist(playlistId) {
  const limit = 100;
  let offset = 0;
  let all = [];

  while (true) {
    const url =
      `https://api.spotify.com/v1/playlists/${encodeURIComponent(playlistId)}/items` +
      `?limit=${limit}&offset=${offset}&market=from_token` +
      `&fields=items(item(type,uri,id,name,artists(name),album(release_date))),total,next`;

    const data = await apiGet(url);
    const items = data.items || [];

    const tracks = items
      .map(x => x?.item ?? x?.track ?? null)
      .filter(t => t && t.type === "track")
      .filter(t => t.name && t.album?.release_date && t.artists?.length);

    all.push(...tracks);

    // Pagination: wenn weniger als limit zur√ºckkommt -> Ende
    if (items.length < limit) break;

    offset += limit;

    // Sicherheitsbremse (falls Spotify spinnt)
    if (offset > 10000) break;
  }

  return all;
}

/*** Playback control ***/
async function getActiveDeviceId() {
  const data = await apiGet("https://api.spotify.com/v1/me/player/devices");
  const devices = data.devices || [];
  const active = devices.find(d => d.is_active);
  if (active) return active.id;
  if (devices.length) return devices[0].id;
  return null;
}

async function pausePlayback() {
  const deviceId = await getActiveDeviceId();
  if (!deviceId) { setGameStatus("‚ÑπÔ∏è Kein aktives Spotify-Ger√§t zum Stoppen gefunden."); return; }

  const res = await fetch(
    `https://api.spotify.com/v1/me/player/pause?device_id=${encodeURIComponent(deviceId)}`,
    { method: "PUT", headers: { Authorization: `Bearer ${getToken()}` } }
  );
  if (!res.ok && res.status !== 204) {
    const t = await res.text();
    throw new Error(`Stop/Pause fehlgeschlagen (${res.status}): ${t}`);
  }
  setGameStatus("‚è∏Ô∏è Pausiert.");
}

async function playTrack(track) {
  const deviceId = await getActiveDeviceId();
  if (!deviceId) {
    alert("Kein Spotify-Ger√§t gefunden. √ñffne Spotify (App/Webplayer) und starte kurz einen Song, dann nochmal.");
    return;
  }

  const uri = track.uri || (track.id ? `spotify:track:${track.id}` : null);
  if (!uri) { alert("Track hat keine URI/ID ‚Äì bitte Playlist neu laden."); return; }

  // optional: Ger√§t aktiv setzen
  await fetch(`https://api.spotify.com/v1/me/player`, {
    method: "PUT",
    headers: { Authorization: `Bearer ${getToken()}`, "Content-Type": "application/json" },
    body: JSON.stringify({ device_ids: [deviceId], play: true })
  });

  const res = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${encodeURIComponent(deviceId)}`, {
    method: "PUT",
    headers: { Authorization: `Bearer ${getToken()}`, "Content-Type": "application/json" },
    body: JSON.stringify({ uris: [uri] })
  });

  if (!res.ok && res.status !== 204) {
    const t = await res.text();
    throw new Error(`Play fehlgeschlagen (${res.status}): ${t}`);
  }
}

/*** Setup UI ***/
function buildPlayersForm() {
  const n = Math.max(1, Math.min(12, Number(document.getElementById("numPlayers").value || 1)));
  playersForm.innerHTML = "";

  if (!playlistList.length) {
    setSetupStatus(`<span class="bad">‚ùå Bitte zuerst "Meine Playlists laden".</span>`);
    return;
  }

  for (let i = 0; i < n; i++) {
    const row = document.createElement("div");
    row.className = "playerRow";
    row.innerHTML = `
      <b>Spieler ${i+1}</b>
      <input type="text" placeholder="Name" value="${i===0 ? "Papa" : i===1 ? "Mama" : "Spieler "+(i+1)}" data-field="name"/>
      <select data-field="playlist"></select>
    `;

    const sel = row.querySelector('select[data-field="playlist"]');
    playlistList.forEach(pl => {
      const opt = document.createElement("option");
      opt.value = pl.id;
      opt.textContent = pl.name;
      sel.appendChild(opt);
    });

    playersForm.appendChild(row);
  }

  setSetupStatus(`<span class="ok">‚úÖ Spielerfelder erstellt. W√§hle pro Spieler eine Playlist.</span>`);
}

function readPlayersFromForm() {
  const rows = Array.from(playersForm.querySelectorAll(".playerRow"));
  const out = rows.map(r => {
    const name = (r.querySelector('input[data-field="name"]').value || "").trim() || "Spieler";
    const playlistId = r.querySelector('select[data-field="playlist"]').value;
    return { name, playlistId, tracks: [], bag: [] };
  });

  // Basic validity
  if (!out.length) throw new Error("Keine Spieler definiert.");
  if (out.some(p => !p.playlistId)) throw new Error("Mindestens ein Spieler hat keine Playlist.");

  return out;
}

/*** Shuffle-bag: sorgt daf√ºr, dass nicht st√§ndig derselbe Song kommt ***/
function refillBag(player) {
  // bag = Array von Indizes, gemischt
  const idx = Array.from({ length: player.tracks.length }, (_, i) => i);
  for (let i = idx.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [idx[i], idx[j]] = [idx[j], idx[i]];
  }
  player.bag = idx;
}

function drawSongForPlayer(player) {
  if (!player.tracks.length) throw new Error(`Playlist von ${player.name} hat keine Tracks.`);
  if (!player.bag.length) refillBag(player);
  const i = player.bag.pop();
  return player.tracks[i];
}

/*** Game flow ***/
function resetTurnUI() {
  revealBox.classList.add("hidden");
  revealBox.innerHTML = "";
  revealBtn.classList.add("hidden");
  nextBtn.classList.add("hidden");
  readyBtn.classList.remove("hidden");
}

function showTurnPrompt() {
  const p = players[currentPlayerIndex];
  turnPrompt.textContent = `üé§ ${p.name} ist dran. Bereit?`;
  setGameStatus("");
  resetTurnUI();
}

async function onReady() {
  const p = players[currentPlayerIndex];
  currentSong = drawSongForPlayer(p);

  // Start song (hidden as much as possible)
  try {
    await playTrack(currentSong);
  } catch (e) {
    setGameStatus("‚ùå " + e.message);
    setDebug(e.stack || e.message);
    return;
  }

  // UI: now only Reveal
  readyBtn.classList.add("hidden");
  revealBtn.classList.remove("hidden");
  setGameStatus("üéµ L√§uft‚Ä¶ (nur Reveal zum Aufl√∂sen)");
}

async function onReveal() {
  if (!currentSong) return;

  try { await pausePlayback(); } catch {}

  const year = (currentSong.album?.release_date || "").slice(0, 4) || "?";
  const artists = (currentSong.artists || []).map(a => a.name).join(", ");

  revealBox.innerHTML = `<b>${currentSong.name}</b><br>${artists}<br>Jahr: ${year}`;
  revealBox.classList.remove("hidden");

  revealBtn.classList.add("hidden");
  nextBtn.classList.remove("hidden");
  setGameStatus("‚û°Ô∏è Weiter f√ºr n√§chsten Spieler");
}

function onNext() {
  currentSong = null;
  currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
  showTurnPrompt();
}

/*** Start game: load all chosen playlists automatically ***/
async function startGame() {
  if (!getToken()) {
    setSetupStatus(`<span class="bad">‚ùå Bitte zuerst mit Spotify verbinden.</span>`);
    return;
  }
  if (!playlistList.length) {
    setSetupStatus(`<span class="bad">‚ùå Bitte zuerst "Meine Playlists laden".</span>`);
    return;
  }

  let chosen;
  try {
    chosen = readPlayersFromForm();
  } catch (e) {
    setSetupStatus(`<span class="bad">‚ùå ${e.message}</span>`);
    return;
  }

  setSetupStatus("‚è≥ Lade alle Playlists vollst√§ndig‚Ä¶ (kann je nach Gr√∂√üe kurz dauern)");
  setDebug("");

  // Load each playlist fully and attach tracks
  try {
    for (let i = 0; i < chosen.length; i++) {
      const p = chosen[i];
      setSetupStatus(`‚è≥ Lade Playlist f√ºr <b>${p.name}</b>‚Ä¶`);
      const tracks = await loadAllTracksForPlaylist(p.playlistId);
      p.tracks = tracks;
      p.bag = [];
      setDebug(`Geladen f√ºr ${p.name}: ${tracks.length} Tracks\n` + (debugEl.textContent || ""));
    }
  } catch (e) {
    setSetupStatus(`<span class="bad">‚ùå Laden fehlgeschlagen: ${e.message}</span>`);
    setDebug(e.stack || e.message);
    return;
  }

  // Done
  players = chosen;
  currentPlayerIndex = 0;
  currentSong = null;

  setSetupStatus(`<span class="ok">‚úÖ Fertig. Spiel startet!</span>`);
  showGame();
  showTurnPrompt();
}

/*** wire up ***/
document.getElementById("loginBtn").onclick = login;
document.getElementById("logoutBtn").onclick = logout;

document.getElementById("loadPlaylistsBtn").onclick = loadPlaylists;
document.getElementById("testMeBtn").onclick = testMe;
document.getElementById("buildPlayersBtn").onclick = buildPlayersForm;
document.getElementById("startGameBtn").onclick = startGame;

readyBtn.onclick = () => onReady().catch(e => { setGameStatus("‚ùå " + e.message); setDebug(e.stack || e.message); });
revealBtn.onclick = () => onReveal().catch(e => { setGameStatus("‚ùå " + e.message); setDebug(e.stack || e.message); });
nextBtn.onclick = onNext;

stopBtn.onclick = () => pausePlayback().catch(e => { setGameStatus("‚ùå " + e.message); setDebug(e.stack || e.message); });

refreshConnStatus();
showSetup();
</script>

</body>
</html>
