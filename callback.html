<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Spotify Callback</title>
</head>
<body>

<h1>Spotify Callback</h1>
<p>Verbinde…</p>

<script>
const clientId = "1567cc8cfec14ea2b8562efca5dd7e08";
const redirectUri = "https://Skarvaan.github.io/family-music-quiz/callback.html";

const params = new URLSearchParams(window.location.search);
const code = params.get("code");

async function exchangeToken() {

  const verifier = localStorage.getItem("pkce_verifier");

  const body = new URLSearchParams({
    client_id: clientId,
    grant_type: "authorization_code",
    code: code,
    redirect_uri: redirectUri,
    code_verifier: verifier
  });

  const response = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: body
  });

  const data = await response.json();

  if(data.access_token){
    localStorage.setItem("spotify_access_token", data.access_token);
    document.body.innerHTML += "<pre>✅ Token gespeichert – zurück zur App</pre>";

    setTimeout(() => {
      window.location.href = "./";
    }, 1500);

  } else {
    document.body.innerHTML += "<pre>❌ Token Fehler: "+JSON.stringify(data,null,2)+"</pre>";
  }
}

if(code){
  exchangeToken();
}else{
  document.body.innerHTML += "<pre>❌ Kein Code</pre>";
}
</script>

</body>
</html>
