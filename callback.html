<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Spotify Callback</title>
</head>
<body>
  <h1>Spotify Callback</h1>
  <p>Verbinde…</p>

<script>
const clientId = "1567cc8cfec14ea2b8562efca5dd7e08";
const redirectUri = "https://skarvaan.github.io/family-music-quiz/callback.html";

const params = new URLSearchParams(window.location.search);
const code = params.get("code");
const error = params.get("error");

async function exchangeToken() {
  const verifier = localStorage.getItem("pkce_verifier");

  if (!verifier) {
    document.body.insertAdjacentHTML("beforeend", "<pre>❌ pkce_verifier fehlt. Bitte zurück und erneut verbinden.</pre>");
    return;
  }

  const body = new URLSearchParams({
    client_id: clientId,
    grant_type: "authorization_code",
    code: code,
    redirect_uri: redirectUri,
    code_verifier: verifier
  });

  const response = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body
  });

  const data = await response.json();

  if (data.access_token) {
    localStorage.setItem("spotify_access_token", data.access_token);
    localStorage.setItem("spotify_scope", data.scope || "");
    // optional: refresh_token bekommst du i.d.R. nicht bei PKCE implicit? (je nach Setup)
    // localStorage.setItem("spotify_refresh_token", data.refresh_token || "");

    document.body.insertAdjacentHTML("beforeend",
      `<pre>✅ Token gespeichert</pre><pre>Scopes: ${(data.scope || "(none)")}</pre>`
    );

    setTimeout(() => { window.location.href = "./"; }, 1200);
  } else {
    document.body.insertAdjacentHTML("beforeend",
      "<pre>❌ Token Fehler:\n" + JSON.stringify(data, null, 2) + "</pre>"
    );
  }
}

if (error) {
  document.body.insertAdjacentHTML("beforeend", "<pre>❌ Spotify error: " + error + "</pre>");
} else if (code) {
  exchangeToken();
} else {
  document.body.insertAdjacentHTML("beforeend", "<pre>❌ Kein Code in URL.</pre>");
}
</script>
</body>
</html>
